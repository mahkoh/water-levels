\documentclass[11pt,a4paper]{article}

\usepackage{fullpage}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{xltxtra}
\usepackage{parskip}
\usepackage{svg}
\usepackage{esint}
\usepackage[ruled,linesnumbered]{algorithm2e}

\newtheorem{thm}{Theorem}
\newtheorem{lem}{Lemma}
\newtheorem{rem}{Remark}
\newtheorem{defi}{Definition}
\newtheorem{ex}{Example}

\newcommand{\inv}[1]{\frac{1}{#1}}
\newcommand{\norm}[1]{\left\lVert #1 \right\rVert}
\newcommand{\R}{\mathbb{R}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\bO}{\mathcal{O}}
\newcommand{\Rp}{\mathbb{R}_+}

\makeatletter
\def\thm@space@setup{\thm@preskip=\parskip \thm@postskip=0pt}
\makeatother

\begin{document}

Let $\Rp$ be the set of non-negative real numbers.
Let $n\in\N, n > 0$ and let  $e_1, \ldots, e_n \in \Rp$ be a finite sequence describing the elevation levels of a terrain.
Assume that each $e_i$ describes a segment with a width of $1$ unit.

Assume that it is raining and that each segment receives $1$ square unit of water per hour.
The task is to find an algorithm that outputs the water level of each segment after $T\in\Rp$ hours while taking into account the effects of gravity.

\begin{ex}
  The following terrain could be described by the sequence $10, 30, 50, 70, 90, 0, 70, 50$.
  \begin{center}
    \includegraphics{im1.pdf}
  \end{center}
  After $16$ hours it would then look as follows with the water levels being $54, 54, 54, 70, 90, 36, 70, 70$.
  \begin{center}
    \includegraphics{im2.pdf}
  \end{center}
\end{ex}

\begin{rem}
    As seen in the example, we include the underlying elevation of the segment in the water level.
    That is, the water level of the segment $i$ will never be lower than $e_i$.
\end{rem}

In the following we will no longer assume that each $e_i$ describes a segment with a width of $1$ unit.
Instead, let $w_1,\ldots,w_n \in \Rp$ with $w_i > 0$ be a sequence describing the width of the segments.
The original problem can then be solved by setting $w_i = 1$.

In our generalized setting, each segment $i$ receives $w_i$ square units of water per hour.

In the first step, we will look at the case where the terrain has a single local minimum.

\begin{defi}
    We say that the sequence $e_1,\ldots,e_n$ has a single local minimum if there is an
    $i\in\{1,\ldots,n\}$ such that $e_1,\ldots,e_i$ is monotonically decreasing and $e_i,\ldots,e_n$ is monotonically increasing.
\end{defi}

\begin{ex}
  The following terrain has a single local minimum:
  \begin{center}
    \includegraphics{im3.pdf}
  \end{center}
  But this one has multiple local minima:
  \begin{center}
    \includegraphics{im4.pdf}
  \end{center}
\end{ex}

In the second step, we will split terrains into disjoint sequences (called sinks) that each have a single local minimum.

\begin{ex}
  The second example above can be split as follows:
  \begin{center}
    \includegraphics{im5.pdf}
  \end{center}
\end{ex}

For this purpose, note that the problem is invariant under splitting of segments and merging of adjacent segments with identical elevation.

By splitting we mean replacing $e_i$ in place by $e_{i,1} = e_{i,2} = e_i$ and $w_i$ by $w_{i,1}, w_{i,2}$ with $w_{i,1} + w_{i,2} = w_i$.

By merging we mean replacing $e_i, e_{i+1}$ with $e_i = e_{i+1}$ in place by $\hat{e}_i = e_i$ and $w_i, w_{i+1}$ by $\hat{w}_i = w_i + w_{i+1}$.

For each
\begin{align*}
    x \in \left[0, \sum_{i=1}^n w_i\right)
\end{align*}
we can determine the $i$ that contains it by iteratively summing the $w_i$ until the sum exceeds $x$.
With this $i$ we can then determine the original elevation $e_i$ or the resulting water level.

For a finite sequence $x_1,\ldots,x_m$ as above, we can first sort the sequence in $\bO(m\log(m))$ and then determine the elevations or water levels as above by applying the same algorithm in $\bO(\max(m\log(m), n))$ time.
Note that in this case we do not restart the iterative summation for each $x_i$ as this would require $\bO(n^2)$ time.
Instead we use that the $x_i$ are sorted and continue the ongoing summation after we have found the index for the previous element.

\begin{lem}
    Assume that $e_1,\ldots,e_n$ has a single local minimum and $T\in\Rp$.
    Without loss of generality, by merging, we can assume that no two adjacent $e_j$ are identical.
    Then the following algorithm calculates the water levels at time $T$ in $\bO(n)$ time.
\end{lem}

\begin{algorithm}[H]
    Let $i$ be such that $e_i$ is the local minimum of the sequence\; \label{a1:minimum}
    For all $j$, $e_j^0 := e_j$\;
    $i^0 := i$\;
    $n^0 := n$\;
    $V := T\sum_{j=1}^n w_i$\;
    $K := 0$\;
    \While{true}{ \label{a1:while}
        $l := \infty$\;
        \If{$i^K > 1$}{
            $l := e_{i^K-1}^K$\;
        }
        $r := \infty$\;
        \If{$i^K < n^K$}{
            $r := e_{i^K+1}^K$\;
        }
        $m := \min(l, r)$\;
        $u := mw_{i^K}$\;
        \If{$V \le u$}{
            $e_{i^K}^K := e_{i^K}^K + \frac{V}{w_{i^K}}$\;
            break\; \label{a1:break}
        }
        $e_{i^K}^K := m$\;
        \eIf{$l = r$}{ \label{a1:leqr}
            $n^{K+1} := n^K - 2$\;
        }{
            $n^{K+1} := n^K - 1$\;
        }
        Merge $e_{i^K}^K$ with the surrounding segments if possible\; \label{a1:merge}
        Call the resulting sequence $e_1^{K+1},\ldots,e_{n^{K+1}}^{K+1}$\;
        \eIf{$l \le r$}{
            $i^{K+1} := i^K - 1$\;
        }{
            $i^{K+1} := i^K$\;
        }
        $K := K + 1$\;
        $V := V - u$\;
    }
    The $e_1^K,\ldots,e_{n^K}^K$ are the water levels\;
\end{algorithm}

\begin{proof}
The local minimum in line \ref{a1:minimum} can be determined in $\bO(n)$ time by iterating over the sequence.

By induction over $K$ we show that $i^K <= n^K$ and that $n^{K+1}$ is in fact the length of the sequence after the merge step in line \ref{a1:merge}.

If $l = r$ in line \ref{a1:leqr}, then $lw_{i^K} = \min(l,r)w_{i^K} = mw_{i^K} = u < V < \infty$ since otherwise, if $u \ge V$, we would have broken out of the loop in \ref{a1:break}.
Therefore, since $w_{i^K} > 0$, $l = r < \infty$.
By the definitions of $l$ and $r$, it follows that $i^K > 1$ and $i^K < n^K$ and therefore
$e_{i^K-1}^K = l = r = e_{i^K+1}^K$.

\end{proof}


\end{document}
